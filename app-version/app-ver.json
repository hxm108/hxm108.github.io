package web

import (
	"github.com/labstack/echo/v4"
	"strconv"
	"strings"
)

const LatestUnlockMusicVersion = "1.3.2"
const LatestUnlockMusicURL = "https://github.com/ix64/unlock-music/releases/latest"
const LatestUnlockMusicUpdateDetail = "优化PWA更新；优化UI；添加保存文件名选项"

var updateFound = echo.Map{"Found": true, "Version": LatestUnlockMusicVersion,
	"URL": LatestUnlockMusicURL, "Detail": LatestUnlockMusicUpdateDetail}
var updateNotFound = echo.Map{"Found": false}

type getUnlockMusicUpdateRequest struct {
	Version string
}

func getUnlockMusicUpdate(c echo.Context) error {
	verReq := &getUnlockMusicUpdateRequest{}
	err := c.Bind(verReq)
	if err != nil {
		return c.JSON(200, updateFound)
	}
	
	verList := strings.Split(verReq.Version, ".")
	latestVerList := strings.Split(LatestUnlockMusicVersion, ".")
	
	if len(verList) != len(latestVerList) {
		return c.JSON(200, updateFound)
	}
	
	for i := 0; i < len(verList); i++ {
		verCur, errCur := strconv.ParseUint(verList[i], 10, 0)
		verLatest, errLatest := strconv.ParseUint(latestVerList[i], 10, 0)
		if errCur != nil || errLatest != nil || verCur < verLatest {
			return c.JSON(200, updateFound)
		}
	}
	return c.JSON(200, updateNotFound)
}